#!/bin/bash

#
#  ▀▀  SHELLOPTS
# ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
set -o errexit
set -o errtrace
set -o pipefail
set -o noclobber

#
# ▀▀▀  DECLARATIONS
# ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
declare BASE; BASE=$(dirname "$(realpath "$0")")
declare XICO_CACHE="/tmp/xico"
declare XICO_HOME="${XDG_HOME:-${HOME}/.config}/xico"
declare XICO_CONFIG="${XICO_HOME}/xico.conf"
declare SYNOPSIS='xico [-h | --help] [-c | --config FILE] [-i | --input CHAR [--] FILE]'

declare -A S=(
  [geo]=500
  [ext]=png
  [cfg]="$XICO_CONFIG"
  [svg]="${BASE}/src/xico.svg"
  [sed]="${BASE}/src/xico.conf.sed"
)

#
# ▀▀▀  SOURCES
# ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
# shellcheck source=/dev/null
source "${BASE}"/src/xico.debug.sh

#
# ▀▀▀  DEFINITIONS
# ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
function xico.echo { printf "\e[3${1}m%s\e[0m\n" "${*:2}"; }
function xico.fail { xico.echo 1 "[ERROR] $*"; exit 1; }
function xico.help { xico.echo 4 "$SYNOPSIS"; }; # shellcheck disable=SC2317
function xico.trap { (( $? )) && xico.help; }
function xico.make {
  local c="${1:-${S[chr]:?$(xico.kill BAD_INPUT_CHAR)}}"
  local o="${2:-${S[out]:?$(xico.kill BAD_OUTPUT_FILE)}}"
  local b="${o%/*}"
  local s="${S[geo]}"
  local t="${XICO_CACHE}/${RANDOM}.svg"

  {
    [ "$b" != "$o" ] && ! [ -d "$b" ];
  } && mkdir "$b" 2>/dev/null

  sed -e "s/__xico._/${c}/" "${S[svg]}" > "$t"

  inkscape -w "$s" -h "$s" "$t" --export-type "${S[ext]}" -o "$o"
}
function xico.conf {
  [ -e "${S[cfg]}" ] || xico.fail TPL_NOT_FOUND

  cat "${S[cfg]}" - <<< "in 10s";  sleep 10

  local b
  while read -r L; do
    k="${L%% *}"; v="${L##* }"

    [ "$k" == 'base' ] && b="${v}" && continue

    xico.make  "$k" "${b}/${v}"
  done < <(sed -E -f "${S[sed]}" < "${S[cfg]}")
}

#
# ▀▀▀  ERROR TRAPS
# ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
trap xico.trap EXIT

{
  [ -d "${BASE}/src" ] && [ -e "${S[svg]}" ] && [ -e "${S[sed]}" ];
} || xico.fail MISSING_INTERNALS;

[ -d "${XICO_CACHE}" ] || mkdir "${XICO_CACHE}" 2>/dev/null || true

[ -e "$XICO_CONFIG" ] || {
  mkdir -p "${XICO_HOME}"
  cp "${BASE}/src/xico.conf" "$XICO_CONFIG";
}
#
# ▀▀▀  MAIN
# ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
while [[ "$1" =~ ^- && ! "$1" == "--" ]]; do case $1 in
  -i|--input)  S[chr]="$2";S[out]="$3" ;;
  -c|--config) S[cfg]="$2";;
  -s|--size)   S[geo]="$2";;
  -h|--help)   xico.help; exit   ;;
esac; shift; done

xico.debug "${!XICO_@}"; xico.debug "${!S[@]}"

[ -z "$XICO_DEBUG" ] && {
  xico.echo 3 $'\n 🚧 -- WIP -- 🚧\n'
  xico.echo 2 "set XICO_DEBUG to 1 for dev"
  exit
}

[ ! -t 0 ] && { read -r x; S[chr]="$x"; }

[ -n "${S[chr]}" ] && { xico.make; exit; }

xico.conf

#
#
#  ▀▄▀ █ █▀▀ █▀█
#  █░█ █ █▄▄ █▄█
#  ▁▁▁▁▁▁▁▁v0.1▁
#
#

# vim:ft=bash
