#!/bin/bash

#  ▀  SHELLOPTS
# ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
set -o errexit
set -o errtrace
set -o pipefail
set -o noclobber

#
#   ▀  DECLARATIONS
# ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
XICO_BASE="$(dirname "$(realpath "$0")")"
declare -r XICO_CONFIG="${XDG_HOME:-${HOME}/.config}/xico/xico.conf"
declare -r XICO_CACHE="/tmp/xico"
declare -r SYNOPSIS='xico
     -i | --input       <INPUT_CHAR>
     -o | --output      <OUTPUT_FILE>
    [-fg| --foreground  <HEX|NAME>]
    [-bg| --background  <HEX|NAME>]
    [-fs| --font-size   <SIZE_PX|SIZE_EM>]
    [-ff| --font-family <FONT_FAMILY>]
    [-fw| --font-weight <NORMAL|BOLD|BOLDER>]
    [-s | --size        <SIZE_INT>]
    [-x | --x-pos       <POSITION_X>]
    [-y | --y-pos       <POSITION_Y>]
    [-c | --config      <CONFIG_FILE>]
    [-r | --round]
    [-h | --help]
  [[-] <INPUT_CHAR>]'
declare -A STATE=(
    [fontfamily]=monospace
    [fontweight]=bold
    [fontsize]=90px
    [x]=50
    [y]=80
    [fg]='#3311ff'
    [geo]=500
)

#
#   ▀  SOURCES
# ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
# shellcheck source=/dev/null
source "$XICO_BASE"/src/xico.debug.sh
xico_debug "${!XICO_@}"

#
#   ▀  DEFINITIONS
# ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
function xico_echo { printf "\e[3${1}m%s\e[0m\n" "${*:2}"; }
function xico_fail { xico_echo 1 "[ERROR] $*"; exit 1; }
function xico_help { xico_echo 4 "$SYNOPSIS"; }
function xico_trap { (($?)) && xico_help; }
function xico_make {
    local bo=0
    local co=0
    local t="${XICO_CACHE}/${RANDOM}.svg"

    [ -n "${STATE[bg]}" ] && bo=1

    (( STATE[round] )) && co=1 && bo=0

    [ "${STATE[out]%/*}" != "${STATE[out]}" ] && mkdir -p "${STATE[out]%/*}" 2>/dev/null

    sed \
        -e "s/__XICO_IC__/${STATE[chr]}/g" \
        -e "s/__XICO_FG__/${STATE[fg]}/g" \
        -e "s/__XICO_BG__/${STATE[bg]}/g" \
        -e "s/__XICO_BO__/${bo}/g" \
        -e "s/__XICO_CO__/${co}/g" \
        -e "s/__XICO_X__/${STATE[x]}/g" \
        -e "s/__XICO_Y__/${STATE[y]}/g" \
        -e "s/__XICO_FONT_SIZE__/${STATE[fontsize]}/g" \
        -e "s/__XICO_FONT_FAMILY__/${STATE[fontfamily]}/g" \
        -e "s/__XICO_FONT_WEIGHT__/${STATE[fontweight]}/g" \
        "${XICO_BASE}/src/xico.svg" >"$t"

    inkscape -w "${STATE[geo]}" -h "${STATE[geo]}" \
        "$t" --export-type png -o "${STATE[out]}"
}

function xico_conf {
    [ -e "${STATE[cfg]}" ] || xico_fail TPL_NOT_FOUND
    cat "${STATE[cfg]}" - <<<"in 10s"
    sleep 10
    local b
    while read -r L; do
        k="${L%% *}"
        v="${L##* }"
        [ "$k" == 'base' ] && b="$v" && continue
        xico_make "$k" "${b}/${v}"
    done < <(sed -E -f "${STATE[sed]}" <"${STATE[cfg]}")
}

#
#   ▀  ERROR TRAPS
# ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
trap xico_trap EXIT
[ -d "$XICO_CACHE" ] || mkdir "$XICO_CACHE" 2>/dev/null || true
[ -e "$XICO_CONFIG" ] || {
    mkdir -p "$(dirname "$XICO_CONFIG")"
    cp "${BASE}/src/xico.conf" "$XICO_CONFIG"
}

#
#   ▀  MAIN
# ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
while [[ "$1" =~ ^- && ! "$1" == "--" ]]; do
    case $1 in
        -i  | --input       ) shift; STATE[chr]="$1";        ;;
        -o  | --output      ) shift; STATE[out]="$1";        ;;
        -fg | --foreground  ) shift; STATE[fg]="$1";         ;;
        -bg | --background  ) shift; STATE[bg]="$1";         ;;
        -fs | --font-size   ) shift; STATE[fontsize]="$1";   ;;
        -ff | --font-family ) shift; STATE[fontfamily]="$1"; ;;
        -fw | --font-weight ) shift; STATE[fontweight]="$1"; ;;
        -s  | --size        ) shift; STATE[geo]="${1}";      ;;
        -x  | --x-pos       ) shift; STATE[x]="$1";          ;;
        -y  | --y-pos       ) shift; STATE[y]="$1";          ;;
        -c  | --config      ) shift; STATE[cfg]="$1";        ;;
        -r  | --round       )        STATE[round]=1;         ;;
        -h  | --help        ) xico_help; exit;               ;;
    esac
    shift
done



[ ! -t 0 ] && { read -r x; STATE[chr]="$x"; }

xico_debug "${!STATE[@]}"

[ "${STATE[chr]}" = "" ] || [ "${STATE[out]}" = "" ] && xico_fail '-i and -o are required'

xico_make

# TODO: xico_conf

#
#
#  ▀▄▀ █ █▀▀ █▀█
#  █░█ █ █▄▄ █▄█
#  ▁▁▁▁▁▁▁▁v0.2▁
#
#

# vim:ft=bash
